---
title: "05_Stx"
author: "Julian A Paganini"
date: "2026-01-13"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(tidyr)
library(broom)
library(dplyr)
library(readxl)
library(reshape2)
library(tidyverse)
library(viridis)
library(stringr)
library(patchwork)
```

#1. Import data
```{r}
#1. Import summarized data from COG
stx_cog_summary_raw <- read.csv("../../2025_01_stx_analysis/results/merged_all.csv",check.names=FALSE) %>%
  select(-matches("1%complete|99%complete"))

#2. Import stx-metadata
all_metadata <- read.csv("../results/Supplementary_table_S2_all_metadata.csv",check.names=FALSE)

```


```{r}
#categorized stx-genes as fragmented, collapsed or complete
stx_cog_summary_raw$fragmentation_status <- dplyr::case_when(
  stx_cog_summary_raw$contig_stx_blast_assembly >
    stx_cog_summary_raw$virulencefinder_stx_complete ~ "Fragmented stx",

  stx_cog_summary_raw$contig_stx_blast_assembly <
    stx_cog_summary_raw$virulencefinder_stx_complete ~ "Collapsed stx",

  stx_cog_summary_raw$contig_stx_blast_assembly ==
    stx_cog_summary_raw$virulencefinder_stx_complete ~ "Complete stx",

  TRUE ~ NA_character_
)



static_cols <- c(
  "Isolate",
  "Stx_type",
  "virulencefinder_stx_complete",
  "contig_stx_blast_assembly",
  "fragmentation_status"
)

long_mat <- stx_cog_summary_raw %>%
  select(
    all_of(static_cols),
    matches("^(ggcaller|panaroo|ppanggolin|bakta)_stx_(assembly|10%complete|50%complete|90%complete|complete)$")
  ) %>%
  pivot_longer(
    cols = -all_of(static_cols),
    names_to = c("tool_raw", "level_raw"),
    names_pattern = "^(.*)_stx_(.*)$",
    values_to = "stx_value"
  ) %>%
  mutate(
    Tool = recode(tool_raw,
                  ggcaller   = "ggCaller",
                  panaroo    = "Panaroo",
                  ppanggolin = "PPanGGOLiN",
                  bakta      = "BAKTA"),
    complete_genomes = case_when(
      level_raw == "assembly"     ~ 0,
      level_raw == "10%complete"  ~ 10,
      level_raw == "50%complete"  ~ 50,
      level_raw == "90%complete"  ~ 90,
      level_raw == "complete"     ~ 100,
      TRUE ~ NA_real_
    )
  ) %>%
  select(all_of(static_cols), Tool, complete_genomes, stx_value) %>%
  arrange(Isolate, Tool, complete_genomes)


#Add metadata
long_mat<-left_join(long_mat,all_metadata[,c(26,29)],by=c("Isolate"="SRA"))

write.csv(long_mat, '../results/Supplementary_table_S7.csv',  row.names = FALSE)

```

#3. Create remaining BAKTA combinations by mixing the proper files

```{r}
#10_complete
selected_complete_10 <- read.csv("../../2024_01_pangenome_constructions/results/combination_lists/selected_complete_11.csv",check.names=FALSE)
names(selected_complete_10)<-"Isolate"

selected_complete_50 <- read.csv("../../2024_01_pangenome_constructions/results/combination_lists/selected_complete_50.csv",check.names=FALSE)
names(selected_complete_50)<-"Isolate"

selected_complete_90 <- read.csv("../../2024_01_pangenome_constructions/results/combination_lists/selected_complete_89.csv",header=FALSE, check.names=FALSE)
names(selected_complete_90)<-"Isolate"

make_bakta_mixed <- function(long_mat, selected_complete_df, pct) {
  bakta0 <- long_mat %>% filter(Tool == "BAKTA", complete_genomes == 0)
  bakta100 <- long_mat %>% filter(Tool == "BAKTA", complete_genomes == 100)

  sel <- selected_complete_df$Isolate

  mixed <- bind_rows(
    bakta100 %>% filter(Isolate %in% sel),
    bakta0   %>% filter(!Isolate %in% sel)
  ) %>%
    mutate(complete_genomes = pct)

  # sanity check: should recreate the full BAKTA dataset size for that pct
  if (nrow(mixed) != nrow(bakta0) || nrow(mixed) != nrow(bakta100)) {
    warning(
      "Mixed BAKTA rows (", nrow(mixed),
      ") != BAKTA@0 (", nrow(bakta0),
      ") or BAKTA@100 (", nrow(bakta100), "). Check isolate lists."
    )
  }

  mixed
}

# build the missing BAKTA combinations
bakta10 <- make_bakta_mixed(long_mat, selected_complete_10, 10)
bakta50 <- make_bakta_mixed(long_mat, selected_complete_50, 50)
bakta90 <- make_bakta_mixed(long_mat, selected_complete_90, 90)

# remove any existing BAKTA rows at 10/50/90 (if present), then append the new ones
long_mat <- long_mat %>%
  bind_rows(bakta10, bakta50, bakta90)


long_mat <- long_mat %>%
  mutate(
    complete_genomes = recode(complete_genomes, `10` = 11, `90` = 89)
  )
```




#3. Calculate precision and recall

```{r}
#calcualte TP, FP and FN
long_mat<- long_mat %>%
  mutate(
    TP = pmin(stx_value, virulencefinder_stx_complete, na.rm = TRUE),
    FP = pmax(stx_value - virulencefinder_stx_complete, 0),
    FN = pmax(virulencefinder_stx_complete - stx_value, 0)
  )

metrics_summary <- long_mat %>%
  group_by(
    Stx_type,
    fragmentation_status,
    Tool,
    complete_genomes
  ) %>%
  summarise(
    TP = sum(TP, na.rm = TRUE),
    FP = sum(FP, na.rm = TRUE),
    FN = sum(FN, na.rm = TRUE),
    .groups = "drop"
  )

metrics_summary <- metrics_summary %>%
  mutate(
    precision = TP / (TP + FP),
    recall    = TP / (TP + FN)
  )

#write.csv(metrics_summary, '../results/tmp_summary_stx.csv',  row.names = FALSE)
```

#Plot
```{r fig.width=7,fig.height=4, dpi=300}

prep_plot_df <- function(df) {
  df %>%
    mutate(
      complete_genomes = factor(complete_genomes, levels = c(0, 11, 50, 89, 100)),
      fragmentation_status = factor(
        fragmentation_status,
        levels = c("Collapsed stx", "Complete stx", "Fragmented stx")
      )
    ) %>%
    pivot_longer(
      cols = c(precision, recall),
      names_to = "metric",
      values_to = "value"
    ) %>%
    mutate(
      metric = recode(metric,
                      precision = "Precision",
                      recall    = "Recall")
    )
}

plot_one_stx <- function(plot_df, stx_label) {
  dodge <- position_dodge(width = 0.25)
  ggplot(plot_df, aes(
    x = complete_genomes,
    y = value,
    color = Tool,
    group = Tool
  )) +
    geom_step(direction = "mid", linewidth = 1, position=dodge) +   # thicker lines
    geom_point(size = 4, position=dodge) +                          # bigger dots
    facet_grid(metric ~ fragmentation_status) +
    coord_cartesian(ylim = c(0, 1)) +
    labs(
      title = stx_label,
      x = "% complete genomes",
      y = NULL
    ) +
    scale_color_manual(values = c(
      'PPanGGOLiN' = '#FF6600',
      'Panaroo'    = '#E00000',
      'ggCaller'   = '#D9EB00',
      'BAKTA' = 'darkgrey'
    )) +
    theme_bw(base_size = 16) +                        # scales ALL text
    theme(
      plot.title   = element_text(size = 20, face = "bold"),
      strip.text   = element_text(size = 16, face = "bold"),
      axis.title.x = element_text(size = 16, face = "bold"),
      axis.text.x  = element_text(size = 14),
      axis.text.y  = element_text(size = 14),
      legend.title = element_text(size = 16, face = "bold"),
      legend.text  = element_text(size = 14)
    )
}

plot_df <- prep_plot_df(metrics_summary)

p_stxA <- plot_one_stx(filter(plot_df, Stx_type == "stx_A"), "stx A")
p_stxB <- plot_one_stx(filter(plot_df, Stx_type == "stx_B"), "stx B")

p_stxA
p_stxB

```


#Describe fragmentation
```{r}
stx_cog_summary_subunit<-unique(long_mat[,c(1,2,3,5,9)])

fragmentation_summary<-stx_cog_summary_subunit %>% group_by(fragmentation_status,Stx_type) %>% summarize(Summarize_subunit=sum(virulencefinder_stx_complete))

fragmentation_summary_stxtype<-stx_cog_summary_subunit %>% group_by(fragmentation_status,Stx_type,stx_profile) %>% summarize(Summarize_subunit_type=sum(virulencefinder_stx_complete))



#write.csv(fragmentation_summary_stxtype, '../results/tmp_summary_stx_per_type.csv',  row.names = FALSE)

```


```{r}
plot_df <- metrics_summary %>%
  mutate(
    complete_genomes = factor(complete_genomes, levels = c(0, 10, 50, 90, 100)),
    fragmentation_status = factor(
      fragmentation_status,
      levels = c("Collapsed stx", "Complete stx", "Fragmented stx")
    )
  ) %>%
  pivot_longer(
    cols = c(precision, recall),
    names_to = "metric",
    values_to = "value"
  ) %>%
  mutate(metric = recode(metric,
                         precision = "Precision",
                         recall    = "Recall"))

pd <- position_dodge(width = 0.45)

plot_one_stx <- function(df, stx_value, title_label) {
  ggplot(
    df %>% filter(Stx_type == stx_value),
    aes(
      x = complete_genomes,
      y = value,
      color = Tool
    )
  ) +
    geom_point(
      position = pd,
      size = 2.4
    ) +
    facet_grid(metric ~ fragmentation_status, drop = TRUE) +
    coord_cartesian(ylim = c(0, 1)) +
    labs(
      title = title_label,
      x = "% complete genomes",
      y = NULL
    ) +
    theme_bw() +
    theme(
      plot.title   = element_text(face = "bold"),
      strip.text   = element_text(face = "bold"),
      axis.title.x = element_text(face = "bold")
    )
}

p_stxA <- plot_one_stx(plot_df, "stx_A", "stx_A")
p_stxB <- plot_one_stx(plot_df, "stx_B", "stx_B")

p_stxA
p_stxB


```

